<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
    <?define ProductVersion = "1.0.0.0" ?>
    <Package Name="Newt VPN Service"
             Manufacturer="Newt VPN"
             Version="$(var.ProductVersion)"
             UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
             Compressed="yes">

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                      AllowSameVersionUpgrades="yes"
                      Schedule="afterInstallInitialize" />
        <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="NewtService">
                <Component Id="MainExecutables" Guid="11111111-1111-1111-1111-111111111111">
                    <File Id="TrayExe" Source="..\publish\NewtService.Tray.exe" KeyPath="yes" />
                    <File Id="WorkerExe" Source="..\publish\NewtService.Worker.exe" />
                    
                    <!-- Startup registry entry -->
                    <RegistryValue Root="HKCU"
                                   Key="Software\Microsoft\Windows\CurrentVersion\Run"
                                   Name="NewtVPN"
                                   Value="[INSTALLFOLDER]NewtService.Tray.exe"
                                   Type="string" />
                </Component>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="Newt VPN">
                <Component Id="StartMenuShortcut" Guid="33333333-3333-3333-3333-333333333333">
                    <Shortcut Id="ApplicationStartMenuShortcut"
                              Name="Newt VPN"
                              Target="[INSTALLFOLDER]NewtService.Tray.exe"
                              WorkingDirectory="INSTALLFOLDER" />
                    <RemoveFolder Id="CleanUpShortCut" On="uninstall" />
                    <RegistryValue Root="HKCU" Key="Software\NewtService" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                </Component>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="DesktopFolder">
            <Component Id="DesktopShortcut" Guid="44444444-4444-4444-4444-444444444444">
                <Shortcut Id="ApplicationDesktopShortcut"
                          Name="Newt VPN"
                          Target="[INSTALLFOLDER]NewtService.Tray.exe"
                          WorkingDirectory="INSTALLFOLDER" />
                <RegistryValue Root="HKCU" Key="Software\NewtService" Name="desktop" Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </StandardDirectory>

        <Feature Id="ProductFeature" Title="Newt VPN Service" Level="1">
            <ComponentRef Id="MainExecutables" />
            <ComponentRef Id="StartMenuShortcut" />
            <ComponentRef Id="DesktopShortcut" />
        </Feature>

        <!-- Property for config deletion checkbox (unchecked by default = keep config) -->
        <Property Id="DELETECONFIG" Value="0" />
        
        <!-- WiX UI with custom uninstall dialog -->
        <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
        <UIRef Id="WixUI_ErrorProgressText" />
        
        <!-- Custom uninstall confirmation dialog -->
        <UI>
            <Dialog Id="UninstallConfirmDlg" Width="370" Height="270" Title="[ProductName] Uninstall">
                <Control Id="Title" Type="Text" X="15" Y="6" Width="340" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Remove [ProductName]" />
                <Control Id="Description" Type="Text" X="25" Y="23" Width="320" Height="20" Transparent="yes" NoPrefix="yes" Text="You are about to remove [ProductName] from your computer." />
                <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
                
                <Control Id="ConfigCheckBox" Type="CheckBox" X="25" Y="80" Width="320" Height="18" Property="DELETECONFIG" CheckBoxValue="1" Text="Also delete my configuration (connection settings)" />
                <Control Id="ConfigNote" Type="Text" X="40" Y="100" Width="305" Height="30" Transparent="yes" NoPrefix="yes" Text="If unchecked, your settings will be preserved for future installations." />
                
                <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
                <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="Back">
                    <Publish Event="NewDialog" Value="MaintenanceTypeDlg" />
                </Control>
                <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="Remove">
                    <Publish Event="EndDialog" Value="Return" />
                </Control>
                <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
                    <Publish Event="SpawnDialog" Value="CancelDlg" />
                </Control>
            </Dialog>
            
            <!-- Insert our dialog into the uninstall sequence -->
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="UninstallConfirmDlg" Order="2" Condition="1" />
        </UI>

        <!-- Launch app after install -->
        <CustomAction Id="LaunchApp" 
                      FileRef="TrayExe"
                      ExeCommand="--show-config"
                      Impersonate="yes"
                      Return="asyncNoWait" />

        <!-- Stop/remove service on uninstall (hidden window) -->
        <CustomAction Id="KillTray" Execute="deferred" Impersonate="no" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="powershell.exe -WindowStyle Hidden -Command &quot;Stop-Process -Name NewtService.Tray -Force -ErrorAction SilentlyContinue&quot;" />
        <CustomAction Id="StopService" Execute="deferred" Impersonate="no" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="powershell.exe -WindowStyle Hidden -Command &quot;Stop-Service -Name NewtVPN -Force -ErrorAction SilentlyContinue&quot;" />
        <CustomAction Id="DeleteService" Execute="deferred" Impersonate="no" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="powershell.exe -WindowStyle Hidden -Command &quot;sc.exe delete NewtVPN&quot;" />
        
        <!-- Write DELETECONFIG to temp file (immediate can access properties) -->
        <CustomAction Id="SaveDeleteConfigFlag" Execute="immediate" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="powershell.exe -WindowStyle Hidden -Command &quot;[IO.File]::WriteAllText((Join-Path $env:TEMP 'newt_uninstall_flag.txt'), '[DELETECONFIG]')&quot;" />
        
        <!-- Clean up app data files -->
        <CustomAction Id="CleanupAppData" Execute="deferred" Impersonate="no" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="powershell.exe -WindowStyle Hidden -Command &quot;$f = Join-Path $env:TEMP 'newt_uninstall_flag.txt'; $delConfig = (Get-Content $f -EA SilentlyContinue) -eq '1'; Remove-Item $f -Force -EA SilentlyContinue; $p = Join-Path $env:ProgramData 'NewtService'; if (Test-Path $p) { Remove-Item (Join-Path $p 'newt.exe') -Force -EA SilentlyContinue; Remove-Item (Join-Path $p 'version.txt') -Force -EA SilentlyContinue; Remove-Item (Join-Path $p 'logs') -Recurse -Force -EA SilentlyContinue; if ($delConfig) { Remove-Item (Join-Path $p 'config.json') -Force -EA SilentlyContinue }; if ((Get-ChildItem $p -EA SilentlyContinue | Measure-Object).Count -eq 0) { Remove-Item $p -Force -EA SilentlyContinue } }&quot;" />

        <InstallExecuteSequence>
            <Custom Action="SaveDeleteConfigFlag" Before="KillTray" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="KillTray" Before="StopService" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="StopService" Before="DeleteService" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="DeleteService" Before="CleanupAppData" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="CleanupAppData" Before="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="LaunchApp" After="InstallFinalize" Condition="NOT REMOVE" />
        </InstallExecuteSequence>

    </Package>
</Wix>
