<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
    <Package Name="Newt VPN Service"
             Manufacturer="Newt VPN"
             Version="1.0.0.0"
             UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
             Compressed="yes">

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="NewtService">
                <Component Id="MainExecutables" Guid="11111111-1111-1111-1111-111111111111">
                    <File Id="TrayExe" Source="..\publish\NewtService.Tray.exe" KeyPath="yes" />
                    <File Id="WorkerExe" Source="..\publish\NewtService.Worker.exe" />
                    
                    <!-- Startup registry entry -->
                    <RegistryValue Root="HKCU"
                                   Key="Software\Microsoft\Windows\CurrentVersion\Run"
                                   Name="NewtVPN"
                                   Value="[INSTALLFOLDER]NewtService.Tray.exe"
                                   Type="string" />
                </Component>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="Newt VPN">
                <Component Id="StartMenuShortcut" Guid="33333333-3333-3333-3333-333333333333">
                    <Shortcut Id="ApplicationStartMenuShortcut"
                              Name="Newt VPN"
                              Target="[INSTALLFOLDER]NewtService.Tray.exe"
                              WorkingDirectory="INSTALLFOLDER" />
                    <RemoveFolder Id="CleanUpShortCut" On="uninstall" />
                    <RegistryValue Root="HKCU" Key="Software\NewtService" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                </Component>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="DesktopFolder">
            <Component Id="DesktopShortcut" Guid="44444444-4444-4444-4444-444444444444">
                <Shortcut Id="ApplicationDesktopShortcut"
                          Name="Newt VPN"
                          Target="[INSTALLFOLDER]NewtService.Tray.exe"
                          WorkingDirectory="INSTALLFOLDER" />
                <RegistryValue Root="HKCU" Key="Software\NewtService" Name="desktop" Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </StandardDirectory>

        <Feature Id="ProductFeature" Title="Newt VPN Service" Level="1">
            <ComponentRef Id="MainExecutables" />
            <ComponentRef Id="StartMenuShortcut" />
            <ComponentRef Id="DesktopShortcut" />
        </Feature>

        <!-- Launch app after install -->
        <CustomAction Id="LaunchApp" 
                      FileRef="TrayExe"
                      ExeCommand="--show-config"
                      Impersonate="yes"
                      Return="asyncNoWait" />

        <!-- Stop/remove service on uninstall -->
        <CustomAction Id="StopService" Execute="deferred" Impersonate="no" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="cmd.exe /c sc stop NewtVPN" />
        <CustomAction Id="DeleteService" Execute="deferred" Impersonate="no" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="cmd.exe /c sc delete NewtVPN" />
        <CustomAction Id="KillTray" Execute="deferred" Impersonate="no" Return="ignore"
                      Directory="INSTALLFOLDER" ExeCommand="cmd.exe /c taskkill /F /IM NewtService.Tray.exe" />

        <InstallExecuteSequence>
            <Custom Action="KillTray" Before="StopService" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="StopService" Before="DeleteService" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="DeleteService" Before="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
            <Custom Action="LaunchApp" After="InstallFinalize" Condition="NOT REMOVE" />
        </InstallExecuteSequence>

    </Package>
</Wix>
